import{aQ as de,g as ue,r as i,V as ce,k as pe,a0 as d,o as r,a,b as e,w as s,f as p,Q as $,e as _,ao as L,al as U,aR as me,u as ve,c as H,a1 as E,a2 as g,a3 as x,t as n,Z as C,W as O,aS as G,h as W}from"./index-DPlFvZwn.js";import{Q as F}from"./QSelect-BYhptY8v.js";import{Q as Z}from"./QForm-DFmOt1e4.js";import{Q as fe}from"./QPagination-CGwDGw8N.js";import{Q as j}from"./QChip-oqpwgZTq.js";import{Q as k}from"./QMarkupTable-CtZBjmJ5.js";import{Q as N}from"./QSpace-BymvEBrW.js";import{Q as ge}from"./QPage-CBO4L3-i.js";import{I as be}from"./Imprimir-Boki7U77.js";import{h as J}from"./moment-C5S46NFB.js";import"./QMenu-ztewBm2K.js";import"./QItemLabel-4UvomGLM.js";import"./format-DyQxkAtJ.js";import"./_commonjsHelpers-D6-XlEtG.js";const he={class:"row"},xe={class:"col-12"},Ve={class:"col-12 col-md-7"},_e={class:"row"},ye={class:"col-12 col-md-7"},we={class:"col-12 col-md-3"},Ce={class:"col-12 col-md-2 flex flex-center"},ke={class:"row"},Te={class:"col-12 flex flex-center"},Qe=["onClick"],De={class:"text-right"},$e={class:"col-12 col-md-5"},Pe={class:"div"},Se={class:"text-h6 row items-center"},Be={style:{"max-width":"150px","wrap-option":"wrap","line-height":"0.9"}},Me=["onUpdate:modelValue"],ze=["onUpdate:modelValue"],qe={class:"text-right"},Ue={class:"text-bold text-right"},Ee={class:"row"},Fe={class:"col-12 q-pa-xs"},Ne={class:"row"},Re={class:"col-6"},Ye={class:"col-2 flex flex-center"},Ie={class:"col-2 flex flex-center"},Ae={class:"col-2 flex flex-center"},Le={class:"col-12"},He={class:"col-12"},Oe={class:"text-right"},Ge={class:"text-right"},We={class:"text-bold text-right"},Ze={class:"col-12 q-pa-xs"},je={key:0,class:"col-12"},Je={style:{"max-width":"150px","wrap-option":"wrap","line-height":"0.9"}},Ke={class:"text-caption q-mt-md"},Xe={style:{"max-width":"150px","white-space":"normal","line-height":"0.9"}},el={style:{"max-width":"200px","white-space":"normal","line-height":"1.2"}},gl={__name:"VentaAdd",setup(ll){const K=de(),{proxy:u}=ue(),b=i({nombre:"",fecha:new Date().toISOString().slice(0,10)}),R=i([]);i([]);const m=i([]);let y=i("");const T=i(!1),c=i(!1),P=i(1),S=i(1),Q=i("Todos"),X=["Todos","Cirugía","Laboratorio","Peluqueria","Producto","Tratamiento"],D=i([]),B=i([]),h=i(null),w=i(!1),V=i(J().format("YYYY-MM-DD")),Y=i([]);ce(()=>{M(),te()});function ee(o){if(!o?.tratamientoMedicamentos||o.tratamientoMedicamentos.length===0){u.$alert.error("Este tratamiento no tiene medicamentos.");return}o.tratamientoMedicamentos.forEach(t=>{const l=m.value.find(f=>f.nombre===t.medicamento);l?l.cantidadVenta+=t.cantidad:m.value.push({nombre:t.medicamento,cantidadVenta:t.cantidad,precioVenta:t.precio,tipo:"Tratamiento"})}),u.$alert.success("Tratamiento agregado al carrito."),w.value=!1}function I(){if(!V.value){u.$alert.error("Seleccione una fecha","Error");return}c.value=!0,u.$axios.get("tratamientos",{params:{fecha:V.value}}).then(o=>{Y.value=o.data}).finally(()=>{c.value=!1})}function le(){w.value=!0,V.value=J().format("YYYY-MM-DD"),I()}function te(){u.$axios.get("mascotas",{params:{filter:""}}).then(o=>{D.value=o.data.data})}function ae(){console.log(h.value),c.value=!0,u.$axios.post("mascotas/historial",{mascotaId:h.value.id}).then(o=>{console.log(o.data),B.value=o.data}).finally(()=>{c.value=!1})}function A(o){switch(o){case"Cirugía":return"red";case"Laboratorio":return"blue";case"Peluqueria":return"green";case"Producto":return"orange";case"Tratamiento":return"purple";default:return"grey"}}function M(){u.$axios.get("/productos",{params:{filter:y.value,page:P.value,limit:20,tipo:Q.value==="Todos"?"":Q.value}}).then(o=>{R.value=o.data.data,S.value=o.data.last_page})}const z=pe(()=>m.value.reduce((o,t)=>o+t.cantidadVenta*t.precioVenta,0).toFixed(2));function oe(o){const t=m.value.find(l=>l.id===o.id);t?t.cantidadVenta++:m.value.push({...o,cantidadVenta:1,precioVenta:o.precioVenta})}function ne(o){m.value.splice(o,1)}function se(){if(m.value.length===0){u.$alert.error("El carrito está vacío","Error");return}T.value=!0,b.value={comentarioDoctor:"",pago:"Efectivo"},h.value={id:1,nombre:"SN",propietario_nombre:"SN"}}function re(o,t){if(o===""){t(()=>{u.$axios.get("mascotas",{params:{filter:""}}).then(l=>{D.value=l.data.data})});return}t(()=>{u.$axios.get("mascotas",{params:{filter:o}}).then(l=>{D.value=l.data.data})})}function ie(){if(m.value.length===0){u.$alert.error("El carrito está vacío");return}c.value=!0,u.$axios.post("/sales",{mascota:h.value,total:parseFloat(z.value),productos:m.value,comentarioDoctor:b.value.comentarioDoctor,pago:b.value.pago}).then(async o=>{u.$alert.success("Venta realizada con éxito","Éxito"),K.push("/ventas"),be.nota(o.data.sale)}).catch(o=>{u.$alert.error(o.response.data.message,"Error")}).finally(()=>{c.value=!1})}return(o,t)=>(r(),d(g,null,[a(ge,{class:"q-pa-xs"},{default:s(()=>[e("div",he,[e("div",xe,[a(p,{label:"Atras",color:"primary",onClick:t[0]||(t[0]=l=>o.$router.push("/ventas")),"no-caps":"",icon:"arrow_back",size:"10px"})]),e("div",Ve,[a($,{flat:"",bordered:"",class:"q-ma-xs"},{default:s(()=>[a(_,null,{default:s(()=>[a(Z,{onSubmit:L(M,["prevent"])},{default:s(()=>[e("div",_e,[e("div",ye,[a(U,{modelValue:ve(y),"onUpdate:modelValue":t[1]||(t[1]=l=>me(y)?y.value=l:y=l),label:"Buscar producto",outlined:"",dense:"",debounce:"300",clearable:""},null,8,["modelValue"])]),e("div",we,[a(F,{modelValue:Q.value,"onUpdate:modelValue":t[2]||(t[2]=l=>Q.value=l),label:"Tipo",outlined:"",dense:"",options:X},null,8,["modelValue"])]),e("div",Ce,[a(p,{label:"Buscar",color:"primary","no-caps":"",icon:"search",size:"10px",type:"submit"})])])]),_:1}),e("div",ke,[e("div",Te,[S.value>1?(r(),H(fe,{key:0,modelValue:P.value,"onUpdate:modelValue":[t[3]||(t[3]=l=>P.value=l),M],max:S.value,"max-pages":5,"boundary-numbers":"",color:"black"},null,8,["modelValue","max"])):E("",!0)])]),a(k,{dense:"",bordered:"",flat:""},{default:s(()=>[t[13]||(t[13]=e("thead",null,[e("tr",null,[e("th",null,"Cod"),e("th",null,"Nombre"),e("th",null,"Tipo"),e("th",null,"Precio"),e("th",null,"Stock")])],-1)),e("tbody",null,[(r(!0),d(g,null,x(R.value,l=>(r(),d("tr",{onClick:f=>oe(l),key:l.id,style:{cursor:"pointer"}},[e("td",null,n(l.codigo),1),e("td",null,n(l.nombre),1),e("td",null,[a(j,{dense:"",color:A(l.tipo),size:"10px"},{default:s(()=>[C(n(l.tipo),1)]),_:2},1032,["color"])]),e("td",De,n(l.precioVenta),1),e("td",null,n(l.stock),1)],8,Qe))),128))])]),_:1})]),_:1})]),_:1})]),e("div",$e,[a($,{flat:"",bordered:"",class:"q-ma-xs"},{default:s(()=>[a(_,null,{default:s(()=>[e("div",Pe,[e("div",Se,[e("div",null,[t[14]||(t[14]=C(" Carrito ")),a(p,{icon:"history",color:"blue",dense:"",onClick:le,loading:c.value,size:"10px",label:"Recuperar Tratamiento","no-caps":""},null,8,["loading"])]),a(N),a(p,{icon:"delete",color:"red",dense:"",onClick:t[4]||(t[4]=l=>m.value=[]),loading:c.value,size:"10px",label:"Limpiar","no-caps":""},null,8,["loading"])]),t[15]||(t[15]=e("div",{class:"text-caption"},"Productos agregados al carrito",-1))]),a(k,{"wrap-cells":"",dense:"",flat:"",bordered:""},{default:s(()=>[t[18]||(t[18]=e("thead",null,[e("tr",{class:"bg-primary text-white"},[e("th",null,"Producto"),e("th",null,"Cantidad"),e("th",null,"Precio"),e("th",null,"Subtotal"),e("th",null,"Acciones")])],-1)),e("tbody",null,[(r(!0),d(g,null,x(m.value,(l,f)=>(r(),d("tr",{key:f},[e("td",null,[e("div",Be,n(l.nombre),1)]),e("td",null,[O(e("input",{"onUpdate:modelValue":v=>l.cantidadVenta=v,type:"number",style:{width:"50px"},min:"1"},null,8,Me),[[G,l.cantidadVenta,void 0,{number:!0}]])]),e("td",null,[O(e("input",{"onUpdate:modelValue":v=>l.precioVenta=v,type:"number",style:{width:"80px"},min:"1",step:"0.1"},null,8,ze),[[G,l.precioVenta,void 0,{number:!0}]])]),e("td",qe,n((l.cantidadVenta*l.precioVenta).toFixed(2))+" Bs",1),e("td",null,[a(p,{icon:"delete",color:"red",dense:"",onClick:v=>ne(f),loading:c.value,size:"10px"},null,8,["onClick","loading"])])]))),128))]),e("tfoot",null,[e("tr",null,[t[16]||(t[16]=e("td",{colspan:"3",class:"text-right text-bold"},"Total",-1)),e("td",Ue,n(z.value)+" Bs",1),t[17]||(t[17]=e("td",null,null,-1))])])]),_:1}),a(p,{label:"Realizar Venta",color:"positive",class:"full-width q-mt-md","no-caps":"",onClick:se,loading:c.value},null,8,["loading"])]),_:1})]),_:1})])]),a(W,{modelValue:T.value,"onUpdate:modelValue":t[9]||(t[9]=l=>T.value=l)},{default:s(()=>[a($,{flat:"",bordered:"",style:{"max-width":"750px"}},{default:s(()=>[a(_,{class:"q-pb-none row items-center"},{default:s(()=>[t[19]||(t[19]=e("div",{class:"text-bold"}," Realizar Venta ",-1)),a(N),a(p,{flat:"",dense:"",round:"",icon:"close",onClick:t[5]||(t[5]=l=>T.value=!1)})]),_:1}),a(_,null,{default:s(()=>[a(Z,{onSubmit:L(ie,["prevent"])},{default:s(()=>[e("div",Ee,[e("div",Fe,[e("div",Ne,[e("div",Re,[a(F,{"input-debounce":"300",clearable:"","use-input":"",modelValue:h.value,"onUpdate:modelValue":t[6]||(t[6]=l=>h.value=l),label:"Mascota",outlined:"",dense:"",options:D.value,"option-label":l=>l.id+"|"+l.nombre+"|"+l.propietario_nombre,"option-value":l=>l.id,onFilter:re,rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","options","option-label","option-value","rules"])]),e("div",Ye,[a(F,{modelValue:b.value.pago,"onUpdate:modelValue":t[7]||(t[7]=l=>b.value.pago=l),label:"Pago",outlined:"",dense:"",options:["Efectivo","Qr","Transferencia"]},null,8,["modelValue"])]),e("div",Ie,[a(p,{loading:c.value,dense:"",color:"green",label:"Crear","no-caps":"",icon:"add_circle_outline",to:"/mascotas/create"},null,8,["loading"])]),e("div",Ae,[h.value?(r(),H(p,{key:0,loading:c.value,dense:"",color:"blue",label:"historial","no-caps":"",icon:"history",onClick:ae},null,8,["loading"])):E("",!0)])])]),e("div",Le,[a(U,{modelValue:b.value.comentarioDoctor,"onUpdate:modelValue":t[8]||(t[8]=l=>b.value.comentarioDoctor=l),label:"Comentario Doctor",outlined:"",dense:"",type:"textarea",rows:"2"},null,8,["modelValue"])]),e("div",He,[a(k,{"wrap-cells":"",dense:"",flat:"",bordered:""},{default:s(()=>[t[21]||(t[21]=e("thead",null,[e("tr",{class:"bg-primary text-white"},[e("th",null,"Producto"),e("th",null,"Cantidad"),e("th",null,"Tipo"),e("th",null,"Precio"),e("th",null,"Subtotal")])],-1)),e("tbody",null,[(r(!0),d(g,null,x(m.value,(l,f)=>(r(),d("tr",{key:f},[e("td",null,n(l.nombre),1),e("td",null,n(l.cantidadVenta),1),e("td",null,[a(j,{dense:"",color:A(l.tipo),size:"10px"},{default:s(()=>[C(n(l.tipo),1)]),_:2},1032,["color"])]),e("td",Oe,n(l.precioVenta)+" Bs",1),e("td",Ge,n((l.cantidadVenta*l.precioVenta).toFixed(2))+" Bs",1)]))),128))]),e("tfoot",null,[e("tr",null,[t[20]||(t[20]=e("td",{colspan:"3",class:"text-right text-bold"},"Total",-1)),e("td",We,n(z.value)+" Bs",1)])])]),_:1})]),e("div",Ze,[a(p,{label:"Realizar Venta",color:"positive",class:"full-width",type:"submit","no-caps":"",loading:c.value},null,8,["loading"])]),B.value.length>0?(r(),d("div",je,[t[24]||(t[24]=e("div",{class:"text-h6 row items-center"}," Historial de Compras ",-1)),a(k,{flat:"",bordered:"",dense:""},{default:s(()=>[t[23]||(t[23]=e("thead",null,[e("tr",null,[e("td",null,"#"),e("td",null,"Fecha"),e("td",null,"Total"),e("td",null,"Anulado"),e("td",null,"Detalles")])],-1)),e("tbody",null,[(r(!0),d(g,null,x(B.value,(l,f)=>(r(),d("tr",{key:f},[e("td",null,n(l.id),1),e("td",null,n(l.fecha.slice(0,10)),1),e("td",null,n(l.total),1),e("td",null,n(l.anulado?"Si":"No"),1),e("td",null,[e("div",Je,[(r(!0),d(g,null,x(l.details,(v,q)=>(r(),d("span",{key:q},[C(n(v.productoName)+" ("+n(v.cantidad)+")",1),t[22]||(t[22]=e("br",null,null,-1))]))),128))])])]))),128))])]),_:1})])):E("",!0)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(W,{modelValue:w.value,"onUpdate:modelValue":t[12]||(t[12]=l=>w.value=l)},{default:s(()=>[a($,{flat:"",bordered:"",style:{width:"650px"}},{default:s(()=>[a(_,{class:"q-pb-none row items-center"},{default:s(()=>[t[25]||(t[25]=e("div",{class:"text-bold"}," Recuperar Tratamiento ",-1)),a(N),a(p,{flat:"",dense:"",round:"",icon:"close",onClick:t[10]||(t[10]=l=>w.value=!1)})]),_:1}),a(_,null,{default:s(()=>[t[28]||(t[28]=e("div",{class:"text-caption"},"Seleccione una fecha para recuperar el tratamiento",-1)),a(U,{modelValue:V.value,"onUpdate:modelValue":t[11]||(t[11]=l=>V.value=l),type:"date",outlined:"",dense:"",rules:[l=>!!l||"Campo requerido"]},{append:s(()=>[a(p,{dense:"",color:"green",label:"Buscar","no-caps":"",icon:"search",onClick:I,loading:c.value},null,8,["loading"])]),_:1},8,["modelValue","rules"]),e("div",Ke," Tratamientos realizados el "+n(V.value)+": ",1),a(k,{flat:"",bordered:"",dense:""},{default:s(()=>[t[27]||(t[27]=e("thead",null,[e("tr",null,[e("th",null,"#"),e("th",null,"Fecha"),e("th",null,"Doctor"),e("th",null,"Mascota"),e("th",null,"Costo"),e("th",null,"Medicamentos"),e("th",null,"Opciones")])],-1)),e("tbody",null,[(r(!0),d(g,null,x(Y.value,(l,f)=>(r(),d("tr",{key:f},[e("td",null,n(l.id),1),e("td",null,n(l.fecha.slice(0,10)),1),e("td",null,n(l.user?.username||"Desconocido"),1),e("td",null,[e("div",Xe,n(l.historiale?.mascota?.nombre||"Desconocido")+" ("+n(l.historiale?.mascota?.propietario_nombre||"Desconocido")+") ",1)]),e("td",null,n(l.costo)+" Bs",1),e("td",null,[e("div",el,[(r(!0),d(g,null,x(l.tratamientoMedicamentos,(v,q)=>(r(),d("span",{key:q},[C(n(v.medicamento)+" ("+n(v.cantidad)+" x "+n(v.precio)+" Bs) ",1),t[26]||(t[26]=e("br",null,null,-1))]))),128))])]),e("td",null,[a(p,{label:"Recuperar","no-caps":"",dense:"",color:"green",icon:"add_circle_outline",onClick:v=>ee(l)},null,8,["onClick"])])]))),128))])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),t[29]||(t[29]=e("div",{id:"myElement"},null,-1))],64))}};export{gl as default};
